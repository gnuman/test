tinymce.PluginManager.add('equation', function(editor) {
	var escapeEquation = function(s) {
		return ('' + s)
			.replace(/&/g, '&amp;')
			.replace(/'/g, '&apos;')
			.replace(/"/g, '&quot;')
			.replace(/</g, '&lt;')
			.replace(/>/g, '&gt;')
			.replace(/\r\n/g, '&#13;') /* Must be before the next replacement. */
			.replace(/[\r\n]/g, '&#13;');
		;
	};

	function showDialog() {
		var updatePreview = function() {
			var data = win.toJSON();
			win.find('#preview')[0].innerHtml('<img src="https://latex.codecogs.com/gif.latex?' + encodeURIComponent(data.equation) + '">');
		};

		var win = editor.windowManager.open({
			title: 'Enter LaTeX Equation',
			body: [
				{
					type: 'textbox', 
					name: 'equation', 
					label: 'LaTeX Math',
					size: 60,
					onkeyup: updatePreview,
					onchange: updatePreview
				},
				{
					type: 'container',
					name: 'preview',
					minHeight: 60,
					label: ' '
				}
			],
			onSubmit: function(e) {
				var equation = e.data.equation;

				editor.focus();

				editor.undoManager.transact(function() {
					editor.insertContent('<img src="https://latex.codecogs.com/gif.latex?' + encodeURIComponent(equation) + '" alt="' + escapeEquation(equation)  + '" data-value="' + escapeEquation(equation) + '">');
				});

				editor.selection.setCursorLocation();
				editor.nodeChanged();
			}
		});

		console.log(editor.selection);
	}

	editor.addCommand("mceEquationEditor", showDialog);

	editor.addButton('equation', {
		icon: 'equation',
		tooltip: 'Insert Equation',
		onclick: showDialog
	});

	editor.addMenuItem('equation', {
		icon: 'equation',
		text: 'Equation',
		context: 'insert',
		onclick: showDialog
	});
});
